
# -*- coding: utf-8 -*-
"""akbank_finalcase.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/11kzMlY1cB79PLK1TYgNUJddXjKJHINXV
"""

# 1. ADIM: GEREKLÄ° KÃœTÃœPHANELERÄ° YÃœKLEYELÄ°M
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from datetime import datetime
import warnings
warnings.filterwarnings('ignore')

# TÃ¼rkÃ§e karakterler iÃ§in
plt.rcParams['font.family'] = 'DejaVu Sans'

# GÃ¶rselleÅŸtirme ayarlarÄ±
plt.rcParams['figure.figsize'] = (12, 8)
plt.rcParams['font.size'] = 10
sns.set_style("whitegrid")
sns.set_palette("husl")

# UPLOAD EDÄ°LMÄ°Åž DOSYALAR
import os
uploaded_files = [f for f in os.listdir('.') if f.endswith('.csv')]
print(f"YÃ¼klenen CSV dosyalarÄ±: {uploaded_files}")

# DosyalarÄ± otomatik tanÄ±yalÄ±m
users = None
transactions = None

for file in uploaded_files:
    print(f" {file} dosyasÄ± kontrol ediliyor...")

    # Dosya isminden tahmin et
    if 'user' in file.lower():
        users = pd.read_csv(file, low_memory=False)
        print(f" Users dosyasÄ± bulundu: {file} - Boyut: {users.shape}")

    elif 'transaction' in file.lower():
        transactions = pd.read_csv(file, low_memory=False)
        print(f" Transactions dosyasÄ± bulundu: {file} - Boyut: {transactions.shape}")

# EÄŸer otomatik tanÄ±ma Ã§alÄ±ÅŸmazsa manuel yÃ¼kleme
if users is None or transactions is None:
    print("\nâš ï¸ Otomatik tanÄ±ma baÅŸarÄ±sÄ±z! Manuel yÃ¼kleme...")
    print("Dosya isimlerini kontrol edelim:")

    for i, file in enumerate(uploaded_files):
        temp_df = pd.read_csv(file, nrows=5)  # Ä°lk 5 satÄ±rÄ± oku
        print(f"\n{i+1}. {file}:")
        print(f"   Kolonlar: {list(temp_df.columns)}")
        print(f"   Boyut: {pd.read_csv(file).shape}")

# ADIM 2: VERÄ° Ä°NCELEME
if users is not None and transactions is not None:
    print("\n" + "="*60)
    print(" VERÄ° SETLERÄ° DETAYLI Ä°NCELEME")
    print("="*60)

    # Users veri seti
    print("USERS VERÄ° SETÄ°:")
    print(f"   Boyut: {users.shape[0]} satÄ±r, {users.shape[1]} kolon")
    print(f"   Kolonlar: {list(users.columns)}")
    print("   Ä°lk 3 satÄ±r:")
    print(users.head(3))
    print(f"   Veri tipleri:\n{users.dtypes}")

    print("\n TRANSACTIONS VERÄ° SETÄ°:")
    print(f"   Boyut: {transactions.shape[0]} satÄ±r, {transactions.shape[1]} kolon")
    print(f"   Kolonlar: {list(transactions.columns)}")
    print("   Ä°lk 3 satÄ±r:")
    print(transactions.head(3))
    print(f"   Veri tipleri:\n{transactions.dtypes}")

# ADIM 3: EKSÄ°K VERÄ° KONTROLÃœ

print("EKSÄ°K VERÄ° KONTROLÃœ:")
print("Users eksik veriler:")
users_null = users.isnull().sum()
print(users_null[users_null > 0] if users_null.sum() > 0 else "   Eksik veri yok!")

print("\nTransactions eksik veriler:")
trans_null = transactions.isnull().sum()
print(trans_null[trans_null > 0] if trans_null.sum() > 0 else "   Eksik veri yok!")

# ADIM 4: VERÄ° TEMÄ°ZLEME
print("\n VERÄ° TEMÄ°ZLEME...")
users_clean = users.dropna()
transactions_clean = transactions.dropna()

print(f"Users: {users.shape[0]} â†’ {users_clean.shape[0]} satÄ±r (temizlendi)")
print(f"Transactions: {transactions.shape[0]} â†’ {transactions_clean.shape[0]} satÄ±r (temizlendi)")

# ADIM 5: VERÄ° BÄ°RLEÅžTÄ°RME HAZIRLIÄžI

print(" VERÄ° BÄ°RLEÅžTÄ°RME HAZIRLIÄžI:")
print("-" * 40)

# Verilerin yÃ¼klÃ¼ olup olmadÄ±ÄŸÄ±nÄ± kontrol et
try:
    print(f"Users veri boyutu: {users_clean.shape}")
    print(f"Transactions veri boyutu: {transactions_clean.shape}")
except NameError:
    print(" HATA: users_clean veya transactions_clean bulunamadÄ±!")
    print("Ã–nce veri yÃ¼kleme kodlarÄ±nÄ± Ã§alÄ±ÅŸtÄ±r!")
    print("\n Manuel yÃ¼kleme iÃ§in:")
    print("users_clean = pd.read_csv('users.csv').dropna()")
    print("transactions_clean = pd.read_csv('transactions.csv').dropna()")
    exit()

# Ortak kolonlarÄ± bul
common_cols = set(users_clean.columns) & set(transactions_clean.columns)
print(f"\n Ortak kolonlar: {list(common_cols)}")

# TÃ¼m kolonlarÄ± da gÃ¶ster
print(f"\n Users kolonlarÄ±: {list(users_clean.columns)}")
print(f" Transactions kolonlarÄ±: {list(transactions_clean.columns)}")

# Muhtemel birleÅŸtirme kolonlarÄ±nÄ± tespit et
merge_candidates = []
for col in common_cols:
    if any(keyword in col.lower() for keyword in ['user', 'id', 'customer']):
        merge_candidates.append(col)

print(f"\n Muhtemel birleÅŸtirme kolonlarÄ±: {merge_candidates}")

# BirleÅŸtirme iÅŸlemi
if len(merge_candidates) > 0:
    merge_col = merge_candidates[0]
    print(f"\n SeÃ§ilen birleÅŸtirme kolonu: '{merge_col}'")

    # BirleÅŸtirmeden Ã¶nce veri kontrolÃ¼
    print(f"\nUsers '{merge_col}' benzersiz deÄŸer sayÄ±sÄ±: {users_clean[merge_col].nunique()}")
    print(f"Transactions '{merge_col}' benzersiz deÄŸer sayÄ±sÄ±: {transactions_clean[merge_col].nunique()}")

    # Veriyi birleÅŸtir
    print("\n Veriler birleÅŸtiriliyor...")
    merged_data = pd.merge(transactions_clean, users_clean, on=merge_col, how='inner')
    print(f" BirleÅŸtirilmiÅŸ veri boyutu: {merged_data.shape}")

    # BirleÅŸtirilmiÅŸ veriyi kontrol et
    print(f"\n BirleÅŸtirilmiÅŸ veri kolonlarÄ±:")
    for i, col in enumerate(merged_data.columns, 1):
        print(f"   {i}. {col}")

    print(f"\n Ä°lk 3 satÄ±r:")
    print(merged_data.head(3))

    print(f"\nðŸŽ‰ VERÄ° BAÅžARIYLA BÄ°RLEÅžTÄ°RÄ°LDÄ°!")
    print(" Grafik Ã§izmeye hazÄ±rÄ±z!")

else:
    print("\nâš ï¸ Otomatik birleÅŸtirme kolonu bulunamadÄ±!")
    print("Manuel olarak kolon seÃ§men gerekiyor.")
    print(f"Ortak kolonlar: {list(common_cols)}")

    # Manuel seÃ§im iÃ§in Ã¶neriler
    if len(common_cols) > 0:
        print("\n Manuel birleÅŸtirme iÃ§in ÅŸunlarÄ± dene:")
        for col in common_cols:
            print(f"merged_data = pd.merge(transactions_clean, users_clean, on='{col}', how='inner')")
    else:
        print(" HiÃ§ ortak kolon yok! Veri setlerini kontrol et!")

# GRAFÄ°K 1: EN FAZLA HARCAMA YAPILAN ÅžEHÄ°RLER

import matplotlib.pyplot as plt
import numpy as np

print(" GRAFÄ°K 1: En Fazla Harcama YapÄ±lan Åžehirler")
print("=" * 50)

# Åžehir kolonunu kontrol et
print(" Mevcut kolonlarÄ± kontrol ediyoruz...")
city_columns = ['Merchant City', 'City', 'Merchant_City', 'merchant_city']
city_col = None

for col in city_columns:
    if col in merged_data.columns:
        city_col = col
        print(f" Åžehir kolonu bulundu: '{col}'")
        break

if city_col is None:
    print(" Åžehir kolonu bulunamadÄ±!")
    print(f"Mevcut kolonlar: {list(merged_data.columns)}")
    print("Hangi kolon ÅŸehir bilgisini iÃ§eriyor?")
else:
    # Amount kolonunu kontrol et
    amount_columns = ['Amount', 'amount', 'Price', 'Transaction Amount']
    amount_col = None

    for col in amount_columns:
        if col in merged_data.columns:
            amount_col = col
            print(f" Harcama kolonu bulundu: '{col}'")
            break

    if amount_col is None:
        print(" Harcama kolonu bulunamadÄ±!")
        print(f"Mevcut kolonlar: {list(merged_data.columns)}")
    else:
        # Åžehirlere gÃ¶re toplam harcama hesapla
        print(f"\n Åžehirlere gÃ¶re harcama hesaplanÄ±yor...")
        city_spending = merged_data.groupby(city_col)[amount_col].sum().sort_values(ascending=False)

        # Ä°lk 10 ÅŸehir
        top_10_cities = city_spending.head(10)

        print(f" Toplam {len(city_spending)} ÅŸehir bulundu")
        print(f" En fazla harcama yapÄ±lan ilk 10 ÅŸehir:")

        for i, (city, amount) in enumerate(top_10_cities.items(), 1):
            print(f"   {i:2d}. {city}: ${amount:,.2f}")



        plt.figure(figsize=(14, 8))

        # Renk paleti
        colors = plt.cm.Set3(np.linspace(0, 1, len(top_10_cities)))

        # Bar grafik
        bars = plt.bar(range(len(top_10_cities)), top_10_cities.values,
                       color=colors, alpha=0.8, edgecolor='black', linewidth=1)

        # Grafik baÅŸlÄ±ÄŸÄ± ve etiketler
        plt.title('En Fazla Harcama YapÄ±lan Ä°lk 10 Åžehir',
                  fontsize=16, fontweight='bold', pad=20)
        plt.xlabel('Åžehirler', fontsize=12)
        plt.ylabel('Toplam Harcama ($)', fontsize=12)

        # X ekseni etiketleri (ÅŸehir isimleri)
        plt.xticks(range(len(top_10_cities)), top_10_cities.index,
                   rotation=45, ha='right')

        # Bar Ã¼zerine deÄŸerleri yazdÄ±r
        for i, v in enumerate(top_10_cities.values):
            plt.text(i, v + max(top_10_cities.values) * 0.01,
                     f'${v:,.0f}',
                     ha='center', va='bottom', fontweight='bold', fontsize=10)

        # Grid ve dÃ¼zen
        plt.grid(axis='y', alpha=0.3)
        plt.tight_layout()

        # GrafiÄŸi gÃ¶ster
        plt.show()

        # SonuÃ§ analizi
        print(f"\n ANALÄ°Z SONUÃ‡LARI:")
        print(f" En fazla harcama yapÄ±lan ÅŸehir: {top_10_cities.index[0]}")
        print(f" Bu ÅŸehirdeki toplam harcama: ${top_10_cities.iloc[0]:,.2f}")

        # YÃ¼zdelik analiz
        total_spending = city_spending.sum()
        top_3_percentage = (top_10_cities.iloc[:3].sum() / total_spending) * 100
        top_10_percentage = (top_10_cities.sum() / total_spending) * 100

        print(f" Ä°lk 3 ÅŸehir toplam harcamanÄ±n %{top_3_percentage:.1f}'ini oluÅŸturuyor")
        print(f" Ä°lk 10 ÅŸehir toplam harcamanÄ±n %{top_10_percentage:.1f}'ini oluÅŸturuyor")

        print(f"\n YORUM:")
        if top_3_percentage > 50:
            print("   â†’ Harcama bÃ¼yÃ¼k ÅŸehirlerde yoÄŸunlaÅŸmÄ±ÅŸ durumda")
        elif top_10_percentage > 70:
            print("   â†’ Harcama belirli ÅŸehirlerde toplanmÄ±ÅŸ")
        else:
            print("   â†’ Harcama ÅŸehirler arasÄ±nda daha dengeli daÄŸÄ±lmÄ±ÅŸ")

# GRAFÄ°K 2: SAATLÄ°K HARCAMA DAÄžILIMI
# Ã‡izgi grafik ile saatlik harcama desenini

import matplotlib.pyplot as plt
import pandas as pd
import numpy as np

print(" GRAFÄ°K 2: Saatlik Harcama DaÄŸÄ±lÄ±mÄ±")
print("=" * 50)

# Zaman kolonunu bul
print(" Zaman kolonunu arÄ±yoruz...")
time_columns = ['Time', 'Timestamp', 'Date', 'DateTime', 'time', 'timestamp', 'Transaction Time']
time_col = None

for col in time_columns:
    if col in merged_data.columns:
        time_col = col
        print(f" Zaman kolonu bulundu: '{col}'")
        break

if time_col is None:
    print(" Zaman kolonu bulunamadÄ±!")
    print(f"Mevcut kolonlar: {list(merged_data.columns)}")
    print("Hangi kolon zaman bilgisini iÃ§eriyor?")
    print("\n Manuel Ã§Ã¶zÃ¼m:")
    print("time_col = 'KOLON_ISMI'  # Zaman kolonunun ismini yaz")
else:
    # Amount kolonunu kontrol et (Ã¶nceki adÄ±mdan)
    amount_columns = ['Amount', 'amount', 'Price', 'Transaction Amount']
    amount_col = None

    for col in amount_columns:
        if col in merged_data.columns:
            amount_col = col
            break

    print(f" Harcama kolonu: '{amount_col}'")

    # Zaman kolonunu datetime'a Ã§evir
    print(f"\n Zaman verisi iÅŸleniyor...")

    try:
        # Zaman kolonunu datetime'a Ã§evir
        merged_data[time_col] = pd.to_datetime(merged_data[time_col])

        # Saat bilgisini Ã§Ä±kart
        merged_data['Hour'] = merged_data[time_col].dt.hour

        print(f" Zaman verisi baÅŸarÄ±yla iÅŸlendi")
        print(f" Saat aralÄ±ÄŸÄ±: {merged_data['Hour'].min()}:00 - {merged_data['Hour'].max()}:00")

        # Saatlik harcama hesapla
        print(f"\n Saatlik harcamalar hesaplanÄ±yor...")
        hourly_spending = merged_data.groupby('Hour')[amount_col].sum()

        print(f" 24 saat iÃ§in harcama hesaplandÄ±")

        # Saatlik istatistikler
        print(f"\n SAATLÄ°K Ä°STATÄ°STÄ°KLER:")
        for hour in range(0, 24, 4):  # 4 saatte bir gÃ¶ster
            if hour in hourly_spending.index:
                print(f"   {hour:02d}:00 - ${hourly_spending[hour]:,.2f}")

        # En yoÄŸun ve en az harcama saatleri
        peak_hour = hourly_spending.idxmax()
        peak_amount = hourly_spending.max()
        min_hour = hourly_spending.idxmin()
        min_amount = hourly_spending.min()

        print(f"\n En yoÄŸun harcama saati: {peak_hour}:00 - ${peak_amount:,.2f}")
        print(f" En az harcama saati: {min_hour}:00 - ${min_amount:,.2f}")

        # Grafik Ã§izimi
        print(f"\n Ã‡izgi grafik hazÄ±rlanÄ±yor...")

        plt.figure(figsize=(16, 8))

        # Ã‡izgi grafik
        plt.plot(hourly_spending.index, hourly_spending.values,
                 marker='o', linewidth=3, markersize=8, color='#E74C3C',
                 markerfacecolor='white', markeredgecolor='#E74C3C', markeredgewidth=2)

        # Alan doldurmak iÃ§in
        plt.fill_between(hourly_spending.index, hourly_spending.values,
                         alpha=0.3, color='#E74C3C')

        # Grafik baÅŸlÄ±ÄŸÄ± ve etiketler
        plt.title('Saatlik Harcama DaÄŸÄ±lÄ±mÄ±', fontsize=18, fontweight='bold', pad=20)
        plt.xlabel('Saat', fontsize=14)
        plt.ylabel('Toplam Harcama ($)', fontsize=14)

        # X ekseni (0-23 saat)
        plt.xticks(range(0, 24, 2))  # 2 saatte bir gÃ¶ster

        # En yoÄŸun saati iÅŸaretle
        plt.annotate(f'En YoÄŸun Saat\n{peak_hour}:00\n${peak_amount:,.0f}',
                     xy=(peak_hour, peak_amount),
                     xytext=(peak_hour+2, peak_amount+peak_amount*0.15),
                     arrowprops=dict(arrowstyle='->', color='red', lw=2),
                     fontsize=12, fontweight='bold',
                     bbox=dict(boxstyle="round,pad=0.3", facecolor="yellow", alpha=0.8))

        # Grid
        plt.grid(True, alpha=0.3)
        plt.tight_layout()

        # GrafiÄŸi gÃ¶ster
        plt.show()

        # Zaman dilimi analizi
        print(f"\n ZAMAN DÄ°LÄ°MÄ° ANALÄ°ZÄ°:")

        # Zaman dilimlerini tanÄ±mla
        morning = hourly_spending.loc[6:11].sum() if len(hourly_spending.loc[6:11]) > 0 else 0
        afternoon = hourly_spending.loc[12:17].sum() if len(hourly_spending.loc[12:17]) > 0 else 0
        evening = hourly_spending.loc[18:23].sum() if len(hourly_spending.loc[18:23]) > 0 else 0
        night = hourly_spending.loc[0:5].sum() if len(hourly_spending.loc[0:5]) > 0 else 0

        time_periods = {
            'Sabah (06-11)': morning,
            'Ã–ÄŸleden Sonra (12-17)': afternoon,
            'AkÅŸam (18-23)': evening,
            'Gece (00-05)': night
        }

        # En yoÄŸun zaman dilimi
        if max(time_periods.values()) > 0:
            busiest_period = max(time_periods, key=time_periods.get)

            for period, amount in time_periods.items():
                percentage = (amount / hourly_spending.sum()) * 100 if hourly_spending.sum() > 0 else 0
                print(f"   {period}: ${amount:,.2f} (%{percentage:.1f})")

            print(f"\n En yoÄŸun zaman dilimi: {busiest_period}")

        # Yorumlar
        print(f"\n YORUMLAR:")
        if peak_hour >= 9 and peak_hour <= 17:
            print("   â†’ En yoÄŸun harcama iÅŸ saatlerinde gerÃ§ekleÅŸiyor")
        elif peak_hour >= 18 and peak_hour <= 22:
            print("   â†’ En yoÄŸun harcama akÅŸam saatlerinde")
        elif peak_hour >= 6 and peak_hour <= 11:
            print("   â†’ En yoÄŸun harcama sabah saatlerinde")
        else:
            print("   â†’ En yoÄŸun harcama gece/erken sabah saatlerinde")

        # Harcama dÃ¼zenliliÄŸi
        std_dev = hourly_spending.std()
        mean_spending = hourly_spending.mean()
        cv = std_dev / mean_spending if mean_spending > 0 else 0

        if cv < 0.3:
            print("   â†’ Harcama saatler boyunca oldukÃ§a dÃ¼zenli")
        elif cv < 0.6:
            print("   â†’ Harcama saatler arasÄ±nda orta dÃ¼zeyde deÄŸiÅŸiyor")
        else:
            print("   â†’ Harcama saatler arasÄ±nda bÃ¼yÃ¼k farklÄ±lÄ±klar gÃ¶steriyor")


    except Exception as e:
        print(f" Zaman verisi iÅŸlenirken hata: {e}")
        print("Zaman kolonunun formatÄ±nÄ± kontrol et")
        print(f"Ä°lk birkaÃ§ zaman deÄŸeri: {merged_data[time_col].head()}")

# GRAFÄ°K 3: CÄ°NSÄ°YETE GÃ–RE HARCAMA KARÅžILAÅžTIRMASI
# Bar grafik ile kadÄ±n vs erkek harcamalarÄ± karÅŸÄ±laÅŸtÄ±rmasÄ±

import matplotlib.pyplot as plt
import numpy as np

print(" GRAFÄ°K 3: Cinsiyete GÃ¶re Harcama KarÅŸÄ±laÅŸtÄ±rmasÄ±")
print("=" * 60)

# Cinsiyet kolonunu bul
print(" Cinsiyet kolonunu arÄ±yoruz...")
gender_columns = ['Gender', 'gender', 'Sex', 'sex', 'M/F', 'Cinsiyet']
gender_col = None

for col in gender_columns:
    if col in merged_data.columns:
        gender_col = col
        print(f" Cinsiyet kolonu bulundu: '{col}'")
        break

if gender_col is None:
    print(" Cinsiyet kolonu bulunamadÄ±!")
    print(f"Mevcut kolonlar: {list(merged_data.columns)}")
    print("Hangi kolon cinsiyet bilgisini iÃ§eriyor?")
    print("\n Manuel Ã§Ã¶zÃ¼m:")
    print("gender_col = 'KOLON_ISMI'  # Cinsiyet kolonunun ismini yaz")
else:
    # Amount kolonunu al (Ã¶nceki adÄ±mlardan)
    amount_columns = ['Amount', 'amount', 'Price', 'Transaction Amount']
    amount_col = None

    for col in amount_columns:
        if col in merged_data.columns:
            amount_col = col
            break

    print(f" Harcama kolonu: '{amount_col}'")

    # Cinsiyet deÄŸerlerini kontrol et
    print(f"\n Cinsiyet deÄŸerleri inceleniyor...")
    gender_values = merged_data[gender_col].value_counts()
    print(f"Benzersiz cinsiyet deÄŸerleri:")
    for gender, count in gender_values.items():
        print(f"   {gender}: {count} kiÅŸi")

    # Cinsiyete gÃ¶re toplam harcama hesapla
    print(f"\n Cinsiyete gÃ¶re harcama hesaplanÄ±yor...")
    gender_spending = merged_data.groupby(gender_col)[amount_col].sum().sort_values(ascending=False)

    print(f" Cinsiyet bazlÄ± harcamalar hesaplandÄ±")

    # DetaylÄ± istatistikler
    total_spending = gender_spending.sum()
    user_counts = merged_data.groupby(gender_col)['User'].nunique() if 'User' in merged_data.columns else merged_data.groupby(gender_col)[gender_col].count()

    print(f"\n DETAYLI Ä°STATÄ°STÄ°KLER:")
    for gender in gender_spending.index:
        spending = gender_spending[gender]
        percentage = (spending / total_spending) * 100
        user_count = user_counts[gender] if gender in user_counts.index else 0
        avg_per_user = spending / user_count if user_count > 0 else 0

        print(f"   {gender}:")
        print(f"       Toplam Harcama: ${spending:,.2f} (%{percentage:.1f})")
        print(f"       KullanÄ±cÄ± SayÄ±sÄ±: {user_count}")
        print(f"       KullanÄ±cÄ± BaÅŸÄ±na Ort.: ${avg_per_user:,.2f}")

    # Grafik Ã§izimi
    print(f"\n Bar grafik hazÄ±rlanÄ±yor...")

    plt.figure(figsize=(12, 8))

    # Renk seÃ§imi
    if len(gender_spending) == 2:
        colors = ['#3498DB', '#E91E63']  # Mavi ve Pembe
    else:
        colors = plt.cm.Set2(np.linspace(0, 1, len(gender_spending)))

    # Bar grafik
    bars = plt.bar(gender_spending.index, gender_spending.values,
                   color=colors, alpha=0.8, edgecolor='black', linewidth=2)

    # Grafik baÅŸlÄ±ÄŸÄ± ve etiketler
    plt.title('Cinsiyete GÃ¶re Toplam Harcama KarÅŸÄ±laÅŸtÄ±rmasÄ±',
              fontsize=18, fontweight='bold', pad=20)
    plt.xlabel('Cinsiyet', fontsize=14)
    plt.ylabel('Toplam Harcama ($)', fontsize=14)

    # Bar Ã¼zerine deÄŸerleri ve yÃ¼zdeleri yazdÄ±r
    for i, (bar, value) in enumerate(zip(bars, gender_spending.values)):
        percentage = (value / total_spending) * 100
        plt.text(bar.get_x() + bar.get_width()/2,
                 bar.get_height() + max(gender_spending.values) * 0.02,
                 f'${value:,.0f}\n(%{percentage:.1f})',
                 ha='center', va='bottom', fontweight='bold', fontsize=12,
                 bbox=dict(boxstyle="round,pad=0.3", facecolor="white", alpha=0.8))

    # Grid
    plt.grid(axis='y', alpha=0.3)
    plt.tight_layout()

    # GrafiÄŸi gÃ¶ster
    plt.show()

    # SonuÃ§ analizi
    print(f"\n ANALÄ°Z SONUÃ‡LARI:")

    # En fazla harcayan cinsiyet
    top_gender = gender_spending.index[0]
    top_amount = gender_spending.iloc[0]

    print(f" En fazla harcama yapan: {top_gender}")
    print(f" Harcama miktarÄ±: ${top_amount:,.2f}")

    # Harcama farkÄ± analizi
    if len(gender_spending) == 2:
        diff_amount = gender_spending.iloc[0] - gender_spending.iloc[1]
        diff_percentage = (diff_amount / gender_spending.iloc[1]) * 100

        print(f" Harcama farkÄ±: ${diff_amount:,.2f} (%{diff_percentage:.1f})")

        if diff_percentage > 20:
            gap_level = "BÃ¼yÃ¼k"
        elif diff_percentage > 10:
            gap_level = "Orta"
        else:
            gap_level = "KÃ¼Ã§Ã¼k"

        print(f" Fark seviyesi: {gap_level}")

    # KullanÄ±cÄ± baÅŸÄ±na ortalama karÅŸÄ±laÅŸtÄ±rmasÄ±
    print(f"\n KULLANICI BAÅžINA ORTALAMA HARCAMA:")
    avg_spendings = {}
    for gender in gender_spending.index:
        user_count = user_counts[gender] if gender in user_counts.index else 1
        avg_spending = gender_spending[gender] / user_count
        avg_spendings[gender] = avg_spending
        print(f"   {gender}: ${avg_spending:,.2f}")

    # En yÃ¼ksek ortalama harcama
    top_avg_gender = max(avg_spendings, key=avg_spendings.get)
    print(f" En yÃ¼ksek ortalama harcama: {top_avg_gender}")

    # Yorumlar
    print(f"\n YORUMLAR:")

    if len(gender_spending) == 2:
        genders = list(gender_spending.index)
        if diff_percentage > 15:
            print(f"   â†’ {top_gender} cinsiyeti {genders[1]} cinsiyetinden belirgin ÅŸekilde fazla harcama yapÄ±yor")
        elif diff_percentage > 5:
            print(f"   â†’ {top_gender} cinsiyeti {genders[1]} cinsiyetinden biraz daha fazla harcama yapÄ±yor")
        else:
            print("   â†’ Her iki cinsiyet de benzer miktarlarda harcama yapÄ±yor")

    # Pazar payÄ± analizi
    market_share = {}
    for gender, spending in gender_spending.items():
        share = (spending / total_spending) * 100
        market_share[gender] = share

    dominant_gender = max(market_share, key=market_share.get)
    if market_share[dominant_gender] > 60:
        print(f"   â†’ {dominant_gender} cinsiyeti pazarda dominant konumda (%{market_share[dominant_gender]:.1f})")
    elif market_share[dominant_gender] > 55:
        print(f"   â†’ {dominant_gender} cinsiyeti pazarda hafif Ã¼stÃ¼nlÃ¼k saÄŸlÄ±yor (%{market_share[dominant_gender]:.1f})")
    else:
        print("   â†’ Pazar paylarÄ± dengeli daÄŸÄ±lmÄ±ÅŸ durumda")

# GRAFÄ°K 4: GELÄ°R-HARCAMA Ä°LÄ°ÅžKÄ°SÄ° + PROJE TAMAMLAMA
# Son grafik + tÃ¼m sonuÃ§larÄ±n Ã¶zeti

import matplotlib.pyplot as plt
import pandas as pd
import numpy as np

print(" GRAFÄ°K 4: Gelir-Harcama Ä°liÅŸkisi Analizi")
print("=" * 60)

# Gelir kolonunu bul
print(" Gelir kolonunu arÄ±yoruz...")
income_columns = ['Yearly Income - Person', 'Income', 'Annual Income', 'Yearly Income', 'income']
income_col = None

for col in income_columns:
    if col in merged_data.columns:
        income_col = col
        print(f" Gelir kolonu bulundu: '{col}'")
        break

if income_col is None:
    print(" Gelir kolonu bulunamadÄ±!")
    print(f"Mevcut kolonlar: {list(merged_data.columns)}")
    print("Manuel olarak gelir kolonunu belirt:")
    print("income_col = 'KOLON_ISMI'")
else:
    # Amount kolonunu bul
    amount_columns = ['Amount', 'amount', 'Price', 'Transaction Amount']
    amount_col = None

    for col in amount_columns:
        if col in merged_data.columns:
            amount_col = col
            break

    print(f" Harcama kolonu: '{amount_col}'")

    try:
        # Gelir kolonundaki $ iÅŸaretini temizle
        print(f"\nðŸ§¹ Gelir verisi temizleniyor...")
        merged_data['Income_Numeric'] = merged_data[income_col].astype(str).str.replace('$', '').str.replace(',', '')
        merged_data['Income_Numeric'] = pd.to_numeric(merged_data['Income_Numeric'], errors='coerce')

        print(f" Gelir verisi sayÄ±sal formata Ã§evrildi")

        # KullanÄ±cÄ± bazÄ±nda toplam harcama hesapla
        print(f" KullanÄ±cÄ± bazÄ±nda harcama toplamlarÄ± hesaplanÄ±yor...")

        # User kolonunu bul
        user_columns = ['User', 'user', 'UserID', 'Customer', 'customer']
        user_col = None

        for col in user_columns:
            if col in merged_data.columns:
                user_col = col
                break

        if user_col:
            user_summary = merged_data.groupby(user_col).agg({
                amount_col: 'sum',
                'Income_Numeric': 'first'
            }).reset_index()

            # NaN deÄŸerleri temizle
            user_summary = user_summary.dropna()

            print(f"âœ… {len(user_summary)} kullanÄ±cÄ± iÃ§in veri hazÄ±rlandÄ±")

            if len(user_summary) > 0:
                # Scatter plot Ã§iz
                print(f"\n Scatter plot hazÄ±rlanÄ±yor...")

                plt.figure(figsize=(16, 10))

                # Scatter plot - renk harcama miktarÄ±na gÃ¶re
                scatter = plt.scatter(user_summary['Income_Numeric'], user_summary[amount_col],
                                   alpha=0.7, s=80, c=user_summary[amount_col], cmap='viridis',
                                   edgecolors='black', linewidth=0.5)

                # Colorbar ekle
                colorbar = plt.colorbar(scatter)
                colorbar.set_label('Harcama MiktarÄ± ($)', fontsize=12)

                # Grafik baÅŸlÄ±ÄŸÄ± ve etiketler
                plt.title('YÄ±llÄ±k Gelir vs Toplam Harcama Ä°liÅŸkisi', fontsize=18, fontweight='bold', pad=20)
                plt.xlabel('YÄ±llÄ±k Gelir ($)', fontsize=14)
                plt.ylabel('Toplam Harcama ($)', fontsize=14)

                # Trend Ã§izgisi ekle
                try:
                    z = np.polyfit(user_summary['Income_Numeric'], user_summary[amount_col], 1)
                    p = np.poly1d(z)
                    x_trend = np.linspace(user_summary['Income_Numeric'].min(), user_summary['Income_Numeric'].max(), 100)
                    plt.plot(x_trend, p(x_trend), "r--", alpha=0.8, linewidth=3, label='Trend Ã‡izgisi')
                    plt.legend(fontsize=12)
                except:
                    print(" Trend Ã§izgisi Ã§izilemedi")

                plt.grid(True, alpha=0.3)
                plt.tight_layout()
                plt.show()

                # Korelasyon hesapla
                correlation = user_summary['Income_Numeric'].corr(user_summary[amount_col])
                print(f"\n KORELASYON ANALÄ°ZÄ°:")
                print(f"Korelasyon katsayÄ±sÄ±: {correlation:.3f}")

                # Korelasyon yorumlama
                if correlation > 0.7:
                    corr_strength = "Ã‡ok GÃ¼Ã§lÃ¼ Pozitif Ä°liÅŸki"
                elif correlation > 0.5:
                    corr_strength = "GÃ¼Ã§lÃ¼ Pozitif Ä°liÅŸki"
                elif correlation > 0.3:
                    corr_strength = "Orta DÃ¼zeyde Pozitif Ä°liÅŸki"
                elif correlation > 0.1:
                    corr_strength = "ZayÄ±f Pozitif Ä°liÅŸki"
                elif correlation > -0.1:
                    corr_strength = "Ä°liÅŸki Yok"
                else:
                    corr_strength = "Negatif Ä°liÅŸki"

                print(f"Ä°liÅŸki durumu: {corr_strength}")

                # Gelir gruplarÄ± analizi
                print(f"\n GELÄ°R GRUPLARI ANALÄ°ZÄ°:")
                try:
                    user_summary['Income_Group'] = pd.qcut(user_summary['Income_Numeric'], q=5,
                                                         labels=['Ã‡ok DÃ¼ÅŸÃ¼k', 'DÃ¼ÅŸÃ¼k', 'Orta', 'YÃ¼ksek', 'Ã‡ok YÃ¼ksek'])

                    income_group_stats = user_summary.groupby('Income_Group')[amount_col].agg(['mean', 'count']).round(2)

                    for group, row in income_group_stats.iterrows():
                        print(f"   {group}: Ort. ${row['mean']:,.2f} ({int(row['count'])} kullanÄ±cÄ±)")

                    highest_avg_group = income_group_stats['mean'].idxmax()
                    print(f" En yÃ¼ksek ortalama harcama: {highest_avg_group} gelir grubu")

                except:
                    print("   Gelir gruplarÄ± oluÅŸturulamadÄ±")

                print(f"\n GRAFÄ°K 4 TAMAMLANDI!")

            else:
                print(" KullanÄ±cÄ± verisi bulunamadÄ±!")
        else:
            print(" User kolonu bulunamadÄ±!")

    except Exception as e:
        print(f" Hata oluÅŸtu: {e}")

# =====================================
# PROJE TAMAMLAMA VE Ã–ZET SONUÃ‡LAR
# =====================================

print("\n PROJE Ã–ZETÄ° - TÃœM SONUÃ‡LAR:")
print("-" * 50)

print(" TAMAMLANAN AÅžAMALAR:")
print("   1.  Veri YÃ¼kleme ve HazÄ±rlÄ±k")
print("   2.  Åžehirlere GÃ¶re Harcama Analizi (Bar Grafik)")
print("   3.  Saatlik Harcama DaÄŸÄ±lÄ±mÄ± (Ã‡izgi Grafik)")
print("   4.  Cinsiyete GÃ¶re Harcama (Bar Grafik)")
print("   5.  Gelir-Harcama Ä°liÅŸkisi (Scatter Plot)")
print("   6.  Yorumlar ve SonuÃ§lar")
